@startuml Hủy đơn hàng
title Biểu đồ tuần tự - Hủy đơn hàng

actor "Quản trị viên" as Admin
participant "Trình duyệt" as Browser
participant "OrderController" as Controller
participant "Order Model" as OrderModel
participant "Product Model" as ProductModel
participant "Database" as DB

Admin -> Browser: Chọn đơn hàng cần hủy
Browser -> Controller: GET /orders/{id}/cancel
Controller -> OrderModel: findById(orderId)
OrderModel -> DB: SELECT * FROM orders WHERE id = ?
DB -> OrderModel: Trả về thông tin đơn hàng
Controller -> Browser: Hiển thị form hủy đơn hàng

Admin -> Browser: Nhập lý do hủy
Admin -> Browser: Nhấn "Xác nhận hủy"
Browser -> Controller: POST /orders/{id}/cancel

Controller -> OrderModel: checkOrderStatus(orderId)
OrderModel -> DB: SELECT status FROM orders WHERE id = ?

alt Đơn hàng đã được giao
    Controller -> Browser: Redirect với cảnh báo
    Browser -> Admin: Hiển thị thông báo "Đơn hàng đã được giao, không thể hủy"
    
else Đơn hàng chưa được giao
    Controller -> OrderModel: updateStatus(orderId, 'cancelled')
    OrderModel -> DB: UPDATE orders SET status = 'cancelled' WHERE id = ?
    
    Controller -> ProductModel: restoreStockForOrder(orderId)
    ProductModel -> DB: UPDATE products SET stock = stock + quantity
    
    Controller -> Browser: Redirect với thông báo thành công
    Browser -> Admin: Hiển thị "Đơn hàng đã được hủy và tồn kho đã được hoàn trả"
end

@enduml
