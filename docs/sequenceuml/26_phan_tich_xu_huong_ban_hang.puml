@startuml Phân tích xu hướng bán hàng
title Biểu đồ tuần tự - Phân tích xu hướng bán hàng

actor "Quản trị viên" as Admin
participant "Trình duyệt" as Browser
participant "OmniAIController" as Controller
participant "LLMService" as LLMService
participant "Order Model" as OrderModel
participant "Product Model" as ProductModel
participant "Database" as DB

Admin -> Browser: Truy cập trang AI hỗ trợ
Browser -> Controller: GET /omni-ai
Controller -> Browser: Hiển thị giao diện AI

Admin -> Browser: Chọn "Phân tích xu hướng bán hàng"
Browser -> Controller: POST /omni-ai/sales-trend-analysis

Controller -> Controller: Collect historical sales data
Controller -> OrderModel: getSalesTrendData()
OrderModel -> DB: SELECT DATE(created_at) as date, COUNT(*) as orders, SUM(final_amount) as revenue FROM orders WHERE type = 'sale' AND created_at >= DATE_SUB(NOW(), INTERVAL 90 DAY) GROUP BY DATE(created_at) ORDER BY date
DB -> OrderModel: Trả về dữ liệu bán hàng theo ngày
OrderModel -> Controller: Trả về salesTrendData

Controller -> OrderModel: getProductSalesTrend()
OrderModel -> DB: SELECT p.name, p.category, SUM(oi.quantity) as total_sold, SUM(oi.total_price) as revenue FROM order_items oi JOIN products p ON oi.product_id = p.id JOIN orders o ON oi.order_id = o.id WHERE o.type = 'sale' AND o.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY) GROUP BY p.id ORDER BY total_sold DESC
DB -> OrderModel: Trả về xu hướng bán theo sản phẩm
OrderModel -> Controller: Trả về productTrendData

Controller -> OrderModel: getSeasonalTrends()
OrderModel -> DB: SELECT MONTH(created_at) as month, COUNT(*) as orders, SUM(final_amount) as revenue FROM orders WHERE type = 'sale' AND created_at >= DATE_SUB(NOW(), INTERVAL 12 MONTH) GROUP BY MONTH(created_at) ORDER BY month
DB -> OrderModel: Trả về xu hướng theo mùa
OrderModel -> Controller: Trả về seasonalData

Controller -> Controller: Prepare data for AI analysis
note right: Chuẩn bị dữ liệu: xu hướng theo ngày, theo sản phẩm, theo mùa

Controller -> LLMService: analyzeSalesTrends(salesTrendData, productTrendData, seasonalData)
LLMService -> LLMService: Analyze daily sales patterns
LLMService -> LLMService: Identify product performance trends
LLMService -> LLMService: Detect seasonal patterns
LLMService -> LLMService: Predict future trends
LLMService -> LLMService: Generate insights and recommendations

alt AI analysis thành công
    LLMService -> Controller: Trả về trend analysis
    note right: - Xu hướng tăng/giảm doanh thu
    - Sản phẩm có xu hướng tăng/giảm
    - Thời điểm bán chạy nhất
    - Dự đoán xu hướng tương lai
    
    Controller -> Controller: Format analysis results
    Controller -> Browser: Hiển thị báo cáo xu hướng
    Browser -> Admin: Hiển thị:
    note right: - Biểu đồ xu hướng doanh thu
    - Top sản phẩm có xu hướng tăng
    - Cảnh báo sản phẩm có xu hướng giảm
    - Dự đoán doanh thu tương lai
    - Đề xuất chiến lược kinh doanh
    
else AI analysis thất bại
    LLMService -> Controller: Trả về lỗi
    Controller -> Browser: Hiển thị thông báo lỗi
    Browser -> Admin: Hiển thị thông báo không thể phân tích xu hướng
end

@enduml
